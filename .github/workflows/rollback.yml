# ============================================================================
# âª Datadog Runner - ë¡¤ë°± ì›Œí¬í”Œë¡œìš°
# ============================================================================
# ê¸°ëŠ¥:
#   - ì´ì „ ë²„ì „ìœ¼ë¡œ ë¹ ë¥¸ ë¡¤ë°±
#   - íŠ¹ì • ë²„ì „/ì´ë¯¸ì§€ íƒœê·¸ë¡œ ë¡¤ë°±
#   - Datadog DORA Incident ì „ì†¡
# ============================================================================

name: âª Rollback Service

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'ë¡¤ë°±í•  ì„œë¹„ìŠ¤'
        required: true
        type: choice
        options:
          - auth-python
          - chat-node
          - ranking-java
          - frontend-react
          - api-gateway
          - load-generator
      rollback_type:
        description: 'ë¡¤ë°± ë°©ì‹'
        required: true
        type: choice
        default: 'previous'
        options:
          - previous      # ì§ì „ ë²„ì „ìœ¼ë¡œ ë¡¤ë°±
          - specific_tag  # íŠ¹ì • ì´ë¯¸ì§€ íƒœê·¸ë¡œ ë¡¤ë°±
          - undo          # kubectl rollout undo ì‚¬ìš©
      image_tag:
        description: 'ì´ë¯¸ì§€ íƒœê·¸ (specific_tag ì„ íƒ ì‹œ)'
        required: false
        type: string
        default: ''
      reason:
        description: 'ë¡¤ë°± ì‚¬ìœ '
        required: true
        type: string

env:
  AWS_REGION: ap-northeast-2
  ECR_REPOSITORY_PREFIX: datadog-runner
  EKS_CLUSTER_NAME: datadog-runner-cluster
  DD_SITE: datadoghq.com

jobs:
  rollback:
    name: âª Rollback ${{ github.event.inputs.service }}
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“‹ Rollback info
        id: info
        run: |
          echo "ğŸ”´ ë¡¤ë°± ì‹œì‘"
          echo "   ì„œë¹„ìŠ¤: ${{ github.event.inputs.service }}"
          echo "   ë°©ì‹: ${{ github.event.inputs.rollback_type }}"
          echo "   ì‚¬ìœ : ${{ github.event.inputs.reason }}"
          echo ""
          
          # ë¡¤ë°± ì‹œì‘ ì‹œê°„
          echo "started_at=$(date +%s%N)" >> $GITHUB_OUTPUT

      # ========================================
      # AWS ì¸ì¦
      # ========================================
      - name: ğŸ” Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: github-actions-rollback-${{ github.event.inputs.service }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ”‘ Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: ğŸ”§ Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: ğŸ”— Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --region ${{ env.AWS_REGION }} \
            --name ${{ env.EKS_CLUSTER_NAME }}

      # ========================================
      # í˜„ì¬ ìƒíƒœ ì €ì¥
      # ========================================
      - name: ğŸ“Š Get current deployment info
        id: current
        run: |
          SERVICE="${{ github.event.inputs.service }}"
          
          # í˜„ì¬ ì´ë¯¸ì§€ íƒœê·¸ ì €ì¥
          CURRENT_IMAGE=$(kubectl get deployment $SERVICE -o jsonpath='{.spec.template.spec.containers[0].image}')
          echo "current_image=$CURRENT_IMAGE" >> $GITHUB_OUTPUT
          
          # í˜„ì¬ ë ˆí”Œë¦¬ì¹´ ìˆ˜
          REPLICAS=$(kubectl get deployment $SERVICE -o jsonpath='{.spec.replicas}')
          echo "replicas=$REPLICAS" >> $GITHUB_OUTPUT
          
          echo "ğŸ“‹ í˜„ì¬ ë°°í¬ ìƒíƒœ:"
          echo "   ì´ë¯¸ì§€: $CURRENT_IMAGE"
          echo "   ë ˆí”Œë¦¬ì¹´: $REPLICAS"

      # ========================================
      # ë¡¤ë°± ì‹¤í–‰
      # ========================================
      - name: âª Execute rollback
        id: rollback
        run: |
          SERVICE="${{ github.event.inputs.service }}"
          ROLLBACK_TYPE="${{ github.event.inputs.rollback_type }}"
          
          case "$ROLLBACK_TYPE" in
            "undo")
              echo "ğŸ”„ kubectl rollout undo ì‹¤í–‰..."
              kubectl rollout undo deployment/$SERVICE
              TARGET_IMAGE=$(kubectl get deployment $SERVICE -o jsonpath='{.spec.template.spec.containers[0].image}')
              ;;
              
            "previous")
              echo "ğŸ”„ ì§ì „ ReplicaSet ì´ë¯¸ì§€ë¡œ ë¡¤ë°±..."
              # ì§ì „ ReplicaSetì—ì„œ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
              PREVIOUS_RS=$(kubectl get rs -l app=$SERVICE --sort-by='.metadata.creationTimestamp' -o jsonpath='{.items[-2].metadata.name}')
              if [ -z "$PREVIOUS_RS" ]; then
                echo "âŒ ì§ì „ ReplicaSetì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
                exit 1
              fi
              TARGET_IMAGE=$(kubectl get rs $PREVIOUS_RS -o jsonpath='{.spec.template.spec.containers[0].image}')
              echo "ì§ì „ ReplicaSet: $PREVIOUS_RS"
              echo "ë¡¤ë°± ì´ë¯¸ì§€: $TARGET_IMAGE"
              kubectl set image deployment/$SERVICE $SERVICE=$TARGET_IMAGE
              ;;
              
            "specific_tag")
              IMAGE_TAG="${{ github.event.inputs.image_tag }}"
              if [ -z "$IMAGE_TAG" ]; then
                echo "âŒ ì´ë¯¸ì§€ íƒœê·¸ê°€ ì§€ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
                exit 1
              fi
              ECR_REGISTRY="${{ steps.login-ecr.outputs.registry }}"
              TARGET_IMAGE="${ECR_REGISTRY}/${{ env.ECR_REPOSITORY_PREFIX }}/$SERVICE:$IMAGE_TAG"
              echo "ğŸ”„ íŠ¹ì • íƒœê·¸ë¡œ ë¡¤ë°±: $TARGET_IMAGE"
              kubectl set image deployment/$SERVICE $SERVICE=$TARGET_IMAGE
              ;;
          esac
          
          echo "target_image=$TARGET_IMAGE" >> $GITHUB_OUTPUT
          
          echo "â³ ë¡¤ë°± ì™„ë£Œ ëŒ€ê¸° ì¤‘..."
          kubectl rollout status deployment/$SERVICE --timeout=300s
          
          echo "âœ… ë¡¤ë°± ì™„ë£Œ!"
          echo "finished_at=$(date +%s%N)" >> $GITHUB_OUTPUT

      - name: ğŸ“Š Verify rollback
        run: |
          SERVICE="${{ github.event.inputs.service }}"
          
          echo "ğŸ“Š ë¡¤ë°± í›„ ìƒíƒœ:"
          kubectl get deployment $SERVICE -o wide
          echo ""
          echo "ğŸ” Pod ìƒíƒœ:"
          kubectl get pods -l app=$SERVICE

      # ========================================
      # Datadog DORA Incident ì „ì†¡
      # ========================================
      - name: ğŸ“ˆ Send Datadog DORA Incident
        run: |
          echo "ğŸ“Š Datadog DORA Incident ì „ì†¡ ì¤‘..."
          
          RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -X POST \
            "https://api.${{ env.DD_SITE }}/api/v2/dora/incident" \
            -H "Accept: application/json" \
            -H "Content-Type: application/json" \
            -H "DD-API-KEY: ${{ secrets.DD_API_KEY }}" \
            -d @- << EOF
          {
            "data": {
              "attributes": {
                "started_at": ${{ steps.info.outputs.started_at }},
                "finished_at": ${{ steps.rollback.outputs.finished_at }},
                "severity": "medium",
                "service": "${{ github.event.inputs.service }}",
                "env": "demo",
                "name": "Rollback: ${{ github.event.inputs.service }}",
                "git": {
                  "repository_url": "https://github.com/${{ github.repository }}"
                }
              }
            }
          }
          EOF
          )
          
          HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP_STATUS" | cut -d: -f2)
          
          if [[ "$HTTP_STATUS" == "200" ]] || [[ "$HTTP_STATUS" == "201" ]] || [[ "$HTTP_STATUS" == "202" ]]; then
            echo "âœ… DORA Incident ì „ì†¡ ì„±ê³µ!"
          else
            echo "âš ï¸ DORA Incident ì „ì†¡ ì‹¤íŒ¨ (HTTP: $HTTP_STATUS)"
          fi

      # ========================================
      # Slack ì•Œë¦¼
      # ========================================
      - name: ğŸ“¢ Slack Notification
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "âª ${{ github.event.inputs.service }} ë¡¤ë°± ì™„ë£Œ",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*ì„œë¹„ìŠ¤:*\n${{ github.event.inputs.service }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ë¡¤ë°± ë°©ì‹:*\n${{ github.event.inputs.rollback_type }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ì´ì „ ì´ë¯¸ì§€:*\n`${{ steps.current.outputs.current_image }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ë¡¤ë°± ì´ë¯¸ì§€:*\n`${{ steps.rollback.outputs.target_image }}`"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ì‚¬ìœ :*\n${{ github.event.inputs.reason }}"
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "ì‹¤í–‰ì: ${{ github.actor }} | <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|ë¡œê·¸ ë³´ê¸°>"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

