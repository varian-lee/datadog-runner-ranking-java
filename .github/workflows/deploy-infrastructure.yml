# ============================================================================
# ğŸ—ï¸ Datadog Runner - ì¸í”„ë¼ ì„œë¹„ìŠ¤ ë°°í¬ ì›Œí¬í”Œë¡œìš°
# ============================================================================
# ê¸°ëŠ¥:
#   - PostgreSQL, Redis, RabbitMQ ë°°í¬
#   - ì¸í”„ë¼ ì„œë¹„ìŠ¤ í—¬ìŠ¤ì²´í¬
#   - ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” (ì„ íƒ)
# ============================================================================

name: ğŸ—ï¸ Deploy Infrastructure

on:
  workflow_dispatch:
    inputs:
      services:
        description: 'ë°°í¬í•  ì¸í”„ë¼ ì„œë¹„ìŠ¤'
        required: true
        type: choice
        default: 'all'
        options:
          - all
          - postgres
          - redis
          - rabbitmq
      init_database:
        description: 'ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” (ì£¼ì˜!)'
        required: false
        type: boolean
        default: false

env:
  AWS_REGION: ap-northeast-2
  EKS_CLUSTER_NAME: datadog-runner-cluster

jobs:
  deploy-infrastructure:
    name: ğŸ—ï¸ Deploy Infrastructure
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ” Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: github-actions-infra
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ”§ Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: ğŸ”— Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --region ${{ env.AWS_REGION }} \
            --name ${{ env.EKS_CLUSTER_NAME }}

      # ========================================
      # PostgreSQL ë°°í¬
      # ========================================
      - name: ğŸ˜ Deploy PostgreSQL
        if: github.event.inputs.services == 'all' || github.event.inputs.services == 'postgres'
        run: |
          echo "ğŸ˜ PostgreSQL ë°°í¬ ì¤‘..."
          kubectl apply -f infra/infra/k8s/postgres.yaml
          
          echo "â³ PostgreSQL ì¤€ë¹„ ëŒ€ê¸° ì¤‘..."
          kubectl wait --for=condition=ready pod -l app=postgres --timeout=300s
          
          echo "âœ… PostgreSQL ë°°í¬ ì™„ë£Œ!"

      - name: ğŸ”§ Initialize Database
        if: (github.event.inputs.services == 'all' || github.event.inputs.services == 'postgres') && github.event.inputs.init_database == 'true'
        run: |
          echo "âš ï¸ ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì¤‘..."
          
          # Pod ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
          POD=$(kubectl get pod -l app=postgres -o jsonpath='{.items[0].metadata.name}')
          
          # init.sql ì‹¤í–‰
          kubectl cp infra/sql/init.sql $POD:/tmp/init.sql
          kubectl exec $POD -- psql -U app -d app -f /tmp/init.sql
          
          echo "âœ… ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì™„ë£Œ!"

      # ========================================
      # Redis ë°°í¬
      # ========================================
      - name: ğŸ”´ Deploy Redis
        if: github.event.inputs.services == 'all' || github.event.inputs.services == 'redis'
        run: |
          echo "ğŸ”´ Redis ë°°í¬ ì¤‘..."
          kubectl apply -f infra/infra/k8s/redis.yaml
          
          echo "â³ Redis ì¤€ë¹„ ëŒ€ê¸° ì¤‘..."
          kubectl wait --for=condition=ready pod -l app=redis --timeout=300s
          
          echo "âœ… Redis ë°°í¬ ì™„ë£Œ!"

      # ========================================
      # RabbitMQ ë°°í¬
      # ========================================
      - name: ğŸ° Deploy RabbitMQ
        if: github.event.inputs.services == 'all' || github.event.inputs.services == 'rabbitmq'
        run: |
          echo "ğŸ° RabbitMQ ë°°í¬ ì¤‘..."
          kubectl apply -f infra/infra/k8s/rabbitmq.yaml
          
          echo "â³ RabbitMQ ì¤€ë¹„ ëŒ€ê¸° ì¤‘..."
          kubectl wait --for=condition=ready pod -l app=rabbitmq --timeout=300s
          
          echo "âœ… RabbitMQ ë°°í¬ ì™„ë£Œ!"

      # ========================================
      # ìƒíƒœ í™•ì¸
      # ========================================
      - name: ğŸ“Š Verify deployment
        run: |
          echo "ğŸ“Š ì¸í”„ë¼ ì„œë¹„ìŠ¤ ìƒíƒœ:"
          echo ""
          echo "=== Pods ==="
          kubectl get pods -l 'app in (postgres,redis,rabbitmq)'
          echo ""
          echo "=== Services ==="
          kubectl get svc -l 'app in (postgres,redis,rabbitmq)'

      - name: ğŸ“¢ Slack Notification
        if: always()
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "${{ job.status == 'success' && 'âœ…' || 'âŒ' }} ì¸í”„ë¼ ì„œë¹„ìŠ¤ ë°°í¬ ${{ job.status == 'success' && 'ì„±ê³µ' || 'ì‹¤íŒ¨' }}: ${{ github.event.inputs.services }}"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

