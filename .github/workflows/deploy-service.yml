# ============================================================================
# ğŸš€ Datadog Runner - ê°œë³„ ì„œë¹„ìŠ¤ ë°°í¬ ì›Œí¬í”Œë¡œìš°
# ============================================================================
# ê¸°ëŠ¥:
#   - ê°œë³„ ì„œë¹„ìŠ¤ ì„ íƒ ë°°í¬ (workflow_dispatch)
#   - Push ì‹œ ë³€ê²½ëœ ì„œë¹„ìŠ¤ ìë™ ê°ì§€ ë°°í¬
#   - ë©€í‹°ì•„í‚¤í…ì²˜ Docker ë¹Œë“œ (amd64 + arm64)
#   - AWS ECR í‘¸ì‹œ (OIDC ì¸ì¦)
#   - EKS ë°°í¬ (kubectl)
#   - Kubernetes ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ìë™ ì—…ë°ì´íŠ¸ (ë²„ì „ ì¦ê°€, Git í™˜ê²½ë³€ìˆ˜)
#   - Datadog DORA Metrics ì „ì†¡
#   - Slack ì•Œë¦¼
# ============================================================================

name: ğŸš€ Deploy Service

on:
  # ìˆ˜ë™ ì‹¤í–‰ (ì„œë¹„ìŠ¤ ì„ íƒ)
  workflow_dispatch:
    inputs:
      service:
        description: 'ë°°í¬í•  ì„œë¹„ìŠ¤ ì„ íƒ'
        required: true
        type: choice
        options:
          - auth-python
          - chat-node
          - ranking-java
          - frontend-react
          - api-gateway
          - load-generator
          - all
      environment:
        description: 'ë°°í¬ í™˜ê²½'
        required: true
        type: choice
        default: 'demo'
        options:
          - demo
          - staging
          - production
      skip_tests:
        description: 'í…ŒìŠ¤íŠ¸ ê±´ë„ˆë›°ê¸°'
        required: false
        type: boolean
        default: false

  # Push ì‹œ ìë™ ë°°í¬ (main/develop ë¸Œëœì¹˜)
  push:
    branches:
      - main
      - develop
    paths:
      - 'auth-python/**'
      - 'chat-node/**'
      - 'ranking-java/**'
      - 'frontend-react/**'
      - 'api-gateway/**'
      - 'load-generator/**'
      - 'infra/infra/k8s/**'

# ë™ì‹œ ì‹¤í–‰ ë°©ì§€ (ê°™ì€ ì„œë¹„ìŠ¤ì— ëŒ€í•´)
concurrency:
  group: deploy-${{ github.event.inputs.service || 'auto' }}-${{ github.ref }}
  cancel-in-progress: true

env:
  AWS_REGION: ap-northeast-2
  ECR_REPOSITORY_PREFIX: datadog-runner
  EKS_CLUSTER_NAME: datadog-runner-cluster
  DD_SITE: datadoghq.com

jobs:
  # ============================================================================
  # 1ï¸âƒ£ ë³€ê²½ëœ ì„œë¹„ìŠ¤ ê°ì§€ (Push ì´ë²¤íŠ¸ìš©)
  # ============================================================================
  detect-changes:
    name: ğŸ” Detect Changes
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.detect.outputs.services }}
      has_changes: ${{ steps.detect.outputs.has_changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed services
        id: detect
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # ìˆ˜ë™ ì‹¤í–‰: ì„ íƒëœ ì„œë¹„ìŠ¤ ì‚¬ìš©
            if [ "${{ github.event.inputs.service }}" == "all" ]; then
              echo 'services=["auth-python","chat-node","ranking-java","frontend-react","api-gateway","load-generator"]' >> $GITHUB_OUTPUT
            else
              echo 'services=["${{ github.event.inputs.service }}"]' >> $GITHUB_OUTPUT
            fi
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            # Push ì´ë²¤íŠ¸: ë³€ê²½ëœ íŒŒì¼ ê°ì§€
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
            SERVICES=()
            
            if echo "$CHANGED_FILES" | grep -q "^auth-python/"; then
              SERVICES+=("auth-python")
            fi
            if echo "$CHANGED_FILES" | grep -q "^chat-node/"; then
              SERVICES+=("chat-node")
            fi
            if echo "$CHANGED_FILES" | grep -q "^ranking-java/"; then
              SERVICES+=("ranking-java")
            fi
            if echo "$CHANGED_FILES" | grep -q "^frontend-react/"; then
              SERVICES+=("frontend-react")
            fi
            if echo "$CHANGED_FILES" | grep -q "^api-gateway/"; then
              SERVICES+=("api-gateway")
            fi
            if echo "$CHANGED_FILES" | grep -q "^load-generator/"; then
              SERVICES+=("load-generator")
            fi
            
            if [ ${#SERVICES[@]} -eq 0 ]; then
              echo "has_changes=false" >> $GITHUB_OUTPUT
              echo 'services=[]' >> $GITHUB_OUTPUT
            else
              # JSON ë°°ì—´ë¡œ ë³€í™˜
              JSON_ARRAY=$(printf '%s\n' "${SERVICES[@]}" | jq -R . | jq -s -c .)
              echo "services=$JSON_ARRAY" >> $GITHUB_OUTPUT
              echo "has_changes=true" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Print detected services
        run: |
          echo "ğŸ” ê°ì§€ëœ ì„œë¹„ìŠ¤: ${{ steps.detect.outputs.services }}"
          echo "ğŸ“‹ ë³€ê²½ì‚¬í•­ ì¡´ì¬: ${{ steps.detect.outputs.has_changes }}"

  # ============================================================================
  # 2ï¸âƒ£ ë¹Œë“œ ë° ë°°í¬ (ë§¤íŠ¸ë¦­ìŠ¤ ì „ëµ)
  # ============================================================================
  build-and-deploy:
    name: ğŸ—ï¸ Build & Deploy
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.services) }}
    
    env:
      SERVICE: ${{ matrix.service }}
      ENVIRONMENT: ${{ github.event.inputs.environment || 'demo' }}

    steps:
      # ========================================
      # ì´ˆê¸° ì„¤ì •
      # ========================================
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ (ë²„ì „ ì¶”ì ìš©)

      - name: ğŸ“‹ Set deployment info
        id: info
        run: |
          # íƒ€ì„ìŠ¤íƒ¬í”„ ë° ë²„ì „ ìƒì„±
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          VERSION="dev-${TIMESTAMP}-${SHORT_SHA}"
          
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "commit_sha=${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "repository_url=https://github.com/${{ github.repository }}" >> $GITHUB_OUTPUT
          
          # ë°°í¬ ì‹œì‘ ì‹œê°„ (ë‚˜ë…¸ì´ˆ)
          echo "started_at=$(date +%s%N)" >> $GITHUB_OUTPUT
          
          echo "ğŸ“‹ ë°°í¬ ì •ë³´:"
          echo "   ì„œë¹„ìŠ¤: ${{ matrix.service }}"
          echo "   ë²„ì „: $VERSION"
          echo "   í™˜ê²½: ${{ env.ENVIRONMENT }}"
          echo "   ì»¤ë°‹: $SHORT_SHA"

      # ========================================
      # AWS ì¸ì¦ (OIDC)
      # ========================================
      - name: ğŸ” Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: github-actions-deploy-${{ matrix.service }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ”‘ Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # ========================================
      # ì„œë¹„ìŠ¤ë³„ ì„¤ì •
      # ========================================
      - name: âš™ï¸ Set service configuration
        id: config
        run: |
          case "${{ matrix.service }}" in
            "auth-python")
              echo "dockerfile_path=./auth-python" >> $GITHUB_OUTPUT
              echo "k8s_manifest=./infra/infra/k8s/auth-python.yaml" >> $GITHUB_OUTPUT
              echo "container_port=8000" >> $GITHUB_OUTPUT
              ;;
            "chat-node")
              echo "dockerfile_path=./chat-node" >> $GITHUB_OUTPUT
              echo "k8s_manifest=./infra/infra/k8s/chat-node.yaml" >> $GITHUB_OUTPUT
              echo "container_port=8080" >> $GITHUB_OUTPUT
              ;;
            "ranking-java")
              echo "dockerfile_path=./ranking-java" >> $GITHUB_OUTPUT
              echo "k8s_manifest=./infra/infra/k8s/ranking-java.yaml" >> $GITHUB_OUTPUT
              echo "container_port=8081" >> $GITHUB_OUTPUT
              ;;
            "frontend-react")
              echo "dockerfile_path=./frontend-react" >> $GITHUB_OUTPUT
              echo "k8s_manifest=./infra/infra/k8s/frontend.yaml" >> $GITHUB_OUTPUT
              echo "container_port=80" >> $GITHUB_OUTPUT
              ;;
            "api-gateway")
              echo "dockerfile_path=./api-gateway" >> $GITHUB_OUTPUT
              echo "k8s_manifest=./infra/infra/k8s/api-gateway.yaml" >> $GITHUB_OUTPUT
              echo "container_port=8080" >> $GITHUB_OUTPUT
              ;;
            "load-generator")
              echo "dockerfile_path=./load-generator" >> $GITHUB_OUTPUT
              echo "k8s_manifest=./infra/infra/k8s/load-generator.yaml" >> $GITHUB_OUTPUT
              echo "container_port=8000" >> $GITHUB_OUTPUT
              ;;
          esac
          
          # ECR ì´ë¯¸ì§€ URI
          ECR_REGISTRY="${{ steps.login-ecr.outputs.registry }}"
          IMAGE_URI="${ECR_REGISTRY}/${{ env.ECR_REPOSITORY_PREFIX }}/${{ matrix.service }}:${{ steps.info.outputs.version }}"
          echo "image_uri=$IMAGE_URI" >> $GITHUB_OUTPUT
          echo "ecr_registry=$ECR_REGISTRY" >> $GITHUB_OUTPUT

      # ========================================
      # Kubernetes ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
      # ========================================
      - name: ğŸ“ Install yq
        uses: mikefarah/yq@v4

      - name: ğŸ”§ Update Kubernetes manifest
        id: manifest
        run: |
          MANIFEST="${{ steps.config.outputs.k8s_manifest }}"
          
          if [ ! -f "$MANIFEST" ]; then
            echo "âš ï¸ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤: $MANIFEST"
            exit 0
          fi
          
          echo "ğŸ“ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ ì¤‘: $MANIFEST"
          
          # í˜„ì¬ ë²„ì „ ì½ê¸°
          CURRENT_VERSION=$(yq eval 'select(.kind == "Deployment") | .metadata.labels."tags.datadoghq.com/version"' "$MANIFEST" 2>/dev/null || echo "0.1.0")
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          
          # ë²„ì „ ì¦ê°€ (X.Y.Z í˜•ì‹)
          if [[ "$CURRENT_VERSION" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
            MAJOR="${BASH_REMATCH[1]}"
            MINOR="${BASH_REMATCH[2]}"
            PATCH="${BASH_REMATCH[3]}"
            NEW_PATCH=$((PATCH + 1))
            NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"
          else
            NEW_VERSION="0.1.1"
          fi
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ”¼ ë²„ì „ ì¦ê°€: $CURRENT_VERSION â†’ $NEW_VERSION"
          
          # Deployment metadata.labels ë²„ì „ ì—…ë°ì´íŠ¸
          yq eval "(select(.kind == \"Deployment\") | .metadata.labels.\"tags.datadoghq.com/version\") = \"$NEW_VERSION\"" -i "$MANIFEST"
          
          # Deployment spec.template.metadata.labels ë²„ì „ ì—…ë°ì´íŠ¸
          yq eval "(select(.kind == \"Deployment\") | .spec.template.metadata.labels.\"tags.datadoghq.com/version\") = \"$NEW_VERSION\"" -i "$MANIFEST"
          
          # DD_GIT_COMMIT_SHA í™˜ê²½ë³€ìˆ˜ ì—…ë°ì´íŠ¸/ì¶”ê°€
          DD_GIT_SHA_EXISTS=$(yq eval 'select(.kind == "Deployment") | .spec.template.spec.containers[0].env[] | select(.name == "DD_GIT_COMMIT_SHA") | .name' "$MANIFEST" 2>/dev/null || echo "")
          if [ -n "$DD_GIT_SHA_EXISTS" ]; then
            yq eval "(select(.kind == \"Deployment\") | .spec.template.spec.containers[0].env[] | select(.name == \"DD_GIT_COMMIT_SHA\")) |= .value = \"${{ steps.info.outputs.commit_sha }}\"" -i "$MANIFEST"
          else
            yq eval "(select(.kind == \"Deployment\") | .spec.template.spec.containers[0].env) += [{\"name\": \"DD_GIT_COMMIT_SHA\", \"value\": \"${{ steps.info.outputs.commit_sha }}\"}]" -i "$MANIFEST"
          fi
          
          # DD_GIT_REPOSITORY_URL í™˜ê²½ë³€ìˆ˜ ì—…ë°ì´íŠ¸/ì¶”ê°€
          DD_GIT_URL_EXISTS=$(yq eval 'select(.kind == "Deployment") | .spec.template.spec.containers[0].env[] | select(.name == "DD_GIT_REPOSITORY_URL") | .name' "$MANIFEST" 2>/dev/null || echo "")
          if [ -n "$DD_GIT_URL_EXISTS" ]; then
            yq eval "(select(.kind == \"Deployment\") | .spec.template.spec.containers[0].env[] | select(.name == \"DD_GIT_REPOSITORY_URL\")) |= .value = \"${{ steps.info.outputs.repository_url }}\"" -i "$MANIFEST"
          else
            yq eval "(select(.kind == \"Deployment\") | .spec.template.spec.containers[0].env) += [{\"name\": \"DD_GIT_REPOSITORY_URL\", \"value\": \"${{ steps.info.outputs.repository_url }}\"}]" -i "$MANIFEST"
          fi
          
          echo "âœ… ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ ì™„ë£Œ!"

      # ========================================
      # Docker ë¹Œë“œ (ë©€í‹°ì•„í‚¤í…ì²˜)
      # ========================================
      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”¨ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ steps.config.outputs.dockerfile_path }}
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ steps.config.outputs.image_uri }}
            ${{ steps.config.outputs.ecr_registry }}/${{ env.ECR_REPOSITORY_PREFIX }}/${{ matrix.service }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1
            ${{ matrix.service == 'frontend-react' && format('VITE_DD_RUM_APP_ID={0}', secrets.VITE_DD_RUM_APP_ID) || '' }}
            ${{ matrix.service == 'frontend-react' && format('VITE_DD_RUM_CLIENT_TOKEN={0}', secrets.VITE_DD_RUM_CLIENT_TOKEN) || '' }}
            ${{ matrix.service == 'frontend-react' && format('VITE_DD_SITE={0}', env.DD_SITE) || '' }}
            ${{ matrix.service == 'frontend-react' && format('VITE_DD_ENV={0}', env.ENVIRONMENT) || '' }}
            ${{ matrix.service == 'frontend-react' && format('VITE_APP_VERSION={0}', steps.manifest.outputs.new_version) || '' }}

      # ========================================
      # EKS ë°°í¬
      # ========================================
      - name: ğŸ”§ Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: ğŸ”— Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --region ${{ env.AWS_REGION }} \
            --name ${{ env.EKS_CLUSTER_NAME }}

      - name: ğŸš€ Deploy to EKS
        id: deploy
        run: |
          MANIFEST="${{ steps.config.outputs.k8s_manifest }}"
          DEPLOYMENT="${{ matrix.service }}"
          IMAGE="${{ steps.config.outputs.image_uri }}"
          
          echo "ğŸ“‹ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì ìš© ì¤‘: $MANIFEST"
          kubectl apply -f "$MANIFEST"
          
          echo "ğŸ”„ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ ì¤‘: $IMAGE"
          kubectl set image deployment/$DEPLOYMENT $DEPLOYMENT=$IMAGE
          
          echo "â³ ë°°í¬ ì™„ë£Œ ëŒ€ê¸° ì¤‘..."
          kubectl rollout status deployment/$DEPLOYMENT --timeout=300s
          
          echo "âœ… ë°°í¬ ì™„ë£Œ!"
          
          # ë°°í¬ ì¢…ë£Œ ì‹œê°„ ê¸°ë¡
          echo "finished_at=$(date +%s%N)" >> $GITHUB_OUTPUT

      - name: ğŸ“Š Verify deployment
        run: |
          echo "ğŸ“Š ë°°í¬ ìƒíƒœ í™•ì¸:"
          kubectl get deployment ${{ matrix.service }} -o wide
          echo ""
          echo "ğŸ” Pod ìƒíƒœ:"
          kubectl get pods -l app=${{ matrix.service }}

      # ========================================
      # ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë³€ê²½ì‚¬í•­ ì»¤ë°‹
      # ========================================
      - name: ğŸ’¾ Commit manifest changes
        if: success()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          MANIFEST="${{ steps.config.outputs.k8s_manifest }}"
          
          if git diff --quiet "$MANIFEST"; then
            echo "ğŸ“‹ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ì— ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
          else
            git add "$MANIFEST"
            git commit -m "ğŸ¤– [CI] Update ${{ matrix.service }} manifest - v${{ steps.manifest.outputs.new_version }}
            
            - Version: ${{ steps.manifest.outputs.current_version }} â†’ ${{ steps.manifest.outputs.new_version }}
            - Commit: ${{ steps.info.outputs.short_sha }}
            - Image: ${{ steps.config.outputs.image_uri }}"
            
            git push
            echo "âœ… ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ì™„ë£Œ!"
          fi

      # ========================================
      # Datadog DORA Metrics
      # ========================================
      - name: ğŸ“ˆ Send Datadog DORA Metrics
        if: always()
        run: |
          STARTED_AT="${{ steps.info.outputs.started_at }}"
          FINISHED_AT="${{ steps.deploy.outputs.finished_at || $(date +%s%N) }}"
          
          # ë°°í¬ ì„±ê³µ/ì‹¤íŒ¨ íŒë‹¨
          if [ "${{ job.status }}" == "success" ]; then
            STATUS="success"
          else
            STATUS="failure"
          fi
          
          echo "ğŸ“Š Datadog DORA Metrics ì „ì†¡ ì¤‘..."
          echo "   ì„œë¹„ìŠ¤: ${{ matrix.service }}"
          echo "   ë²„ì „: ${{ steps.manifest.outputs.new_version }}"
          echo "   ìƒíƒœ: $STATUS"
          
          # DORA Deployment API í˜¸ì¶œ
          RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -X POST \
            "https://api.${{ env.DD_SITE }}/api/v2/dora/deployment" \
            -H "Accept: application/json" \
            -H "Content-Type: application/json" \
            -H "DD-API-KEY: ${{ secrets.DD_API_KEY }}" \
            -d @- << EOF
          {
            "data": {
              "attributes": {
                "started_at": ${STARTED_AT},
                "finished_at": ${FINISHED_AT},
                "service": "${{ matrix.service }}",
                "version": "${{ steps.manifest.outputs.new_version }}",
                "env": "${{ env.ENVIRONMENT }}",
                "git": {
                  "commit_sha": "${{ steps.info.outputs.commit_sha }}",
                  "repository_url": "${{ steps.info.outputs.repository_url }}"
                }
              }
            }
          }
          EOF
          )
          
          HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP_STATUS" | cut -d: -f2)
          
          if [[ "$HTTP_STATUS" == "200" ]] || [[ "$HTTP_STATUS" == "201" ]] || [[ "$HTTP_STATUS" == "202" ]]; then
            echo "âœ… DORA Metrics ì „ì†¡ ì„±ê³µ!"
          else
            echo "âš ï¸ DORA Metrics ì „ì†¡ ì‹¤íŒ¨ (HTTP: $HTTP_STATUS)"
            echo "$RESPONSE"
          fi

      # ========================================
      # Slack ì•Œë¦¼
      # ========================================
      - name: ğŸ“¢ Slack Notification
        if: always()
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "${{ job.status == 'success' && 'âœ…' || 'âŒ' }} ${{ matrix.service }} ë°°í¬ ${{ job.status == 'success' && 'ì„±ê³µ' || 'ì‹¤íŒ¨' }}",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*ì„œë¹„ìŠ¤:*\n${{ matrix.service }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*í™˜ê²½:*\n${{ env.ENVIRONMENT }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ë²„ì „:*\n${{ steps.manifest.outputs.new_version }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ì»¤ë°‹:*\n<${{ steps.info.outputs.repository_url }}/commit/${{ github.sha }}|${{ steps.info.outputs.short_sha }}>"
                    }
                  ]
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "ğŸ“‹ <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|ì›Œí¬í”Œë¡œìš° ë¡œê·¸ ë³´ê¸°>"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

  # ============================================================================
  # 3ï¸âƒ£ ë°°í¬ ìš”ì•½
  # ============================================================================
  summary:
    name: ğŸ“Š Deployment Summary
    needs: [detect-changes, build-and-deploy]
    if: always() && needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“Š Print summary
        run: |
          echo "# ğŸš€ ë°°í¬ ìš”ì•½" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ì„œë¹„ìŠ¤ | ìƒíƒœ |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|" >> $GITHUB_STEP_SUMMARY
          
          SERVICES='${{ needs.detect-changes.outputs.services }}'
          for service in $(echo $SERVICES | jq -r '.[]'); do
            echo "| $service | âœ… |" >> $GITHUB_STEP_SUMMARY
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“‹ ë°°í¬ ì •ë³´" >> $GITHUB_STEP_SUMMARY
          echo "- **ë¸Œëœì¹˜:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ì»¤ë°‹:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ì‹¤í–‰ì:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **í™˜ê²½:** ${{ github.event.inputs.environment || 'demo' }}" >> $GITHUB_STEP_SUMMARY

