# ============================================================================
# üê∂ Datadog Runner - Datadog Î™®ÎãàÌÑ∞ÎßÅ Ï≤¥ÌÅ¨ ÏõåÌÅ¨ÌîåÎ°úÏö∞
# ============================================================================
# Í∏∞Îä•:
#   - Î∞∞Ìè¨ ÌõÑ Datadog Î™®ÎãàÌÑ∞ ÏÉÅÌÉú ÌôïÏù∏
#   - ÏóêÎü¨Ïú®/ÏùëÎãµÏãúÍ∞Ñ Ï≤¥ÌÅ¨
#   - Î¨∏Ï†ú Î∞úÏÉù Ïãú ÏûêÎèô Î°§Î∞± (ÏÑ†ÌÉù)
# ============================================================================

name: üê∂ Datadog Health Check

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Ï≤¥ÌÅ¨Ìï† ÏÑúÎπÑÏä§'
        required: true
        type: choice
        options:
          - auth-python
          - chat-node
          - ranking-java
          - frontend-react
          - api-gateway
          - all
      auto_rollback:
        description: 'Î¨∏Ï†ú Ïãú ÏûêÎèô Î°§Î∞±'
        type: boolean
        default: false

  # Îã§Î•∏ ÏõåÌÅ¨ÌîåÎ°úÏö∞ÏóêÏÑú Ìò∏Ï∂ú
  workflow_call:
    inputs:
      service:
        required: true
        type: string
      auto_rollback:
        required: false
        type: boolean
        default: false

env:
  DD_SITE: datadoghq.com

jobs:
  check-monitors:
    name: üîç Check Datadog Monitors
    runs-on: ubuntu-latest
    outputs:
      has_alerts: ${{ steps.check.outputs.has_alerts }}
      alert_count: ${{ steps.check.outputs.alert_count }}
    steps:
      - name: üìã Check info
        run: |
          echo "üê∂ Datadog Î™®ÎãàÌÑ∞ ÏÉÅÌÉú ÌôïÏù∏"
          echo "   ÏÑúÎπÑÏä§: ${{ inputs.service }}"
          echo "   ÏûêÎèô Î°§Î∞±: ${{ inputs.auto_rollback }}"

      - name: üîç Check monitor status
        id: check
        run: |
          SERVICE="${{ inputs.service }}"
          
          # Datadog APIÎ°ú Î™®ÎãàÌÑ∞ ÏÉÅÌÉú Ï°∞Ìöå
          if [ "$SERVICE" == "all" ]; then
            QUERY="env:demo"
          else
            QUERY="service:$SERVICE env:demo"
          fi
          
          echo "üìä Î™®ÎãàÌÑ∞ Ï°∞Ìöå Ï§ë: $QUERY"
          
          RESPONSE=$(curl -s -X GET \
            "https://api.${{ env.DD_SITE }}/api/v1/monitor" \
            -H "Accept: application/json" \
            -H "DD-API-KEY: ${{ secrets.DD_API_KEY }}" \
            -H "DD-APPLICATION-KEY: ${{ secrets.DD_APP_KEY }}" \
            -G --data-urlencode "monitor_tags=$QUERY")
          
          # Alert ÏÉÅÌÉúÏù∏ Î™®ÎãàÌÑ∞ Ïàò ÌôïÏù∏
          ALERT_COUNT=$(echo "$RESPONSE" | jq '[.[] | select(.overall_state == "Alert")] | length')
          
          echo "alert_count=$ALERT_COUNT" >> $GITHUB_OUTPUT
          
          if [ "$ALERT_COUNT" -gt 0 ]; then
            echo "has_alerts=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è $ALERT_COUNTÍ∞úÏùò Î™®ÎãàÌÑ∞Í∞Ä Alert ÏÉÅÌÉúÏûÖÎãàÎã§!"
            
            # Alert Î™®ÎãàÌÑ∞ ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Ï∂úÎ†•
            echo ""
            echo "=== Alert Î™®ÎãàÌÑ∞ Î™©Î°ù ==="
            echo "$RESPONSE" | jq -r '.[] | select(.overall_state == "Alert") | "- \(.name): \(.overall_state)"'
          else
            echo "has_alerts=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Î™®Îì† Î™®ÎãàÌÑ∞Í∞Ä Ï†ïÏÉÅ ÏÉÅÌÉúÏûÖÎãàÎã§."
          fi

      - name: üìä Check APM metrics
        run: |
          SERVICE="${{ inputs.service }}"
          
          if [ "$SERVICE" == "all" ]; then
            echo "Ï†ÑÏ≤¥ ÏÑúÎπÑÏä§ Î©îÌä∏Î¶≠ ÌôïÏù∏ÏùÄ Í±¥ÎÑàÎúÅÎãàÎã§."
            exit 0
          fi
          
          echo "üìä $SERVICE APM Î©îÌä∏Î¶≠ ÌôïÏù∏ Ï§ë..."
          
          # ÏµúÍ∑º 5Î∂ÑÍ∞Ñ ÏóêÎü¨Ïú® Ï°∞Ìöå
          NOW=$(date +%s)
          FROM=$((NOW - 300))
          
          RESPONSE=$(curl -s -X GET \
            "https://api.${{ env.DD_SITE }}/api/v1/query" \
            -H "DD-API-KEY: ${{ secrets.DD_API_KEY }}" \
            -H "DD-APPLICATION-KEY: ${{ secrets.DD_APP_KEY }}" \
            -G --data-urlencode "from=$FROM" \
            --data-urlencode "to=$NOW" \
            --data-urlencode "query=sum:trace.http.request.errors{service:$SERVICE,env:demo}.as_count()")
          
          ERROR_COUNT=$(echo "$RESPONSE" | jq '.series[0].pointlist[-1][1] // 0')
          
          echo "ÏµúÍ∑º 5Î∂ÑÍ∞Ñ ÏóêÎü¨ Ïàò: $ERROR_COUNT"
          
          if [ "$(echo "$ERROR_COUNT > 10" | bc)" -eq 1 ]; then
            echo "‚ö†Ô∏è ÏóêÎü¨Ïú®Ïù¥ ÎÜíÏäµÎãàÎã§!"
          else
            echo "‚úÖ ÏóêÎü¨Ïú® Ï†ïÏÉÅ"
          fi

  # ========================================
  # ÏûêÎèô Î°§Î∞± (Alert Î∞úÏÉù Ïãú)
  # ========================================
  auto-rollback:
    name: ‚è™ Auto Rollback
    needs: check-monitors
    if: needs.check-monitors.outputs.has_alerts == 'true' && inputs.auto_rollback == true
    runs-on: ubuntu-latest
    steps:
      - name: ‚ö†Ô∏è Alert detected
        run: |
          echo "‚ö†Ô∏è ${{ needs.check-monitors.outputs.alert_count }}Í∞úÏùò Alert Î∞úÍ≤¨!"
          echo "ÏûêÎèô Î°§Î∞±ÏùÑ ÏãúÏûëÌï©ÎãàÎã§..."

      - name: ‚è™ Trigger rollback
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'rollback.yml',
              ref: 'main',
              inputs: {
                service: '${{ inputs.service }}',
                rollback_type: 'previous',
                reason: 'ÏûêÎèô Î°§Î∞±: Datadog Alert Í∞êÏßÄ'
              }
            });
            console.log('Î°§Î∞± ÏõåÌÅ¨ÌîåÎ°úÏö∞ Ìä∏Î¶¨Í±∞ ÏôÑÎ£å');

  # ========================================
  # Í≤∞Í≥º Î≥¥Í≥†
  # ========================================
  report:
    name: üìä Report
    needs: [check-monitors, auto-rollback]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: üìä Generate report
        run: |
          echo "# üê∂ Datadog ÏÉÅÌÉú Ï≤¥ÌÅ¨ Í≤∞Í≥º" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Ìï≠Î™© | Í≤∞Í≥º |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ÏÑúÎπÑÏä§ | ${{ inputs.service }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Alert Ïàò | ${{ needs.check-monitors.outputs.alert_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ÏÉÅÌÉú | ${{ needs.check-monitors.outputs.has_alerts == 'true' && '‚ö†Ô∏è Alert' || '‚úÖ Ï†ïÏÉÅ' }} |" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.auto-rollback.result }}" == "success" ]; then
            echo "| ÏûêÎèô Î°§Î∞± | ‚úÖ Ïã§ÌñâÎê® |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: üì¢ Slack Notification
        if: needs.check-monitors.outputs.has_alerts == 'true'
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "‚ö†Ô∏è Datadog Alert Í∞êÏßÄ: ${{ inputs.service }} (${{ needs.check-monitors.outputs.alert_count }}Í∞ú)"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

